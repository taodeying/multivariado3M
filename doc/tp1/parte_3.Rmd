---
title: "Trabajo practico 1"
subtitle: "Ejercicio 3"
author: "Grupo ....."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    extra_dependencies: ["float"]
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center",
  fig.pos = "H", out.extra = "", fig.height = 4, fig.width = 6
)
```


## Librerias

```{r}
library(ggrepel)
library(kableExtra)
library(FactoMineR)
library(tidyverse)
source(here::here("src", "utils.R"))
```


## Datos

En el archivo CUANTITATIVAS se presentan los datos correspondientes a la caracterización agronómica cuantitativa de las 41 variedades de pepino tratadas en el ejercicio anterior. Los caracteres cuantitativos analizados fueron: número de flores femeninas por nudo (FLORES), número de espinas en el ovario (ESPINAS), número de aristas (ARISTAS) y estrías (ESTRIAS) en fruto, longitud de fruto (FRUTO), intensidad de cuello (CUELLO) e intensidad de color de cuello (CCUELLO)

```{r}
datos <- read_csv2(here::here("data", "raw", "CUANTITATIVAS.csv")) %>% 
  rename("VARIEDAD"=X1)
```

Inspeccionamos con `glimpse(datos)`

```{r}
glimpse(datos)
```

**A.** Aplique sobre estos datos un Análisis de Componentes Principales a partir de matriz de correlaciones.

```{r}
fit <- FactoMineR::PCA(
    datos[,-1],          # Remover variables cualitativas
    scale.unit=TRUE,     # Escalar las variables == pca con corr mat
    graph = FALSE
    )

saveRDS(
  fit,
  here::here("doc", "tp1", "shared", "parte_3", "pca.rds")
)
```

```{r}
(round(fit$eig,2)) %>% 
    kable() %>% 
    kable_styling(font_size = 8, full_width = FALSE, latex_options = "HOLD_position") %>% 
    kable_classic_2() 
```

```{r}
aux <- as.data.frame(fit$eig)
aux$comp <- rownames(aux)


ggplot(data = aux) +
    geom_bar(aes(x = comp,
                 weight = `percentage of variance`)) +
    geom_line(aes(x = 1:7,
                  y = `percentage of variance`),
              col = "blue",
              lwd = 1.2) +
    geom_line(aes(x = 1:7,
                  y = `cumulative percentage of variance`),
              col = "red",
              lwd = 1.2) +
    theme_minimal()
```



**B.** Realice la representación de las variedades en el plano principal, encuentre grupos y caracterícelos

```{r}
coord <- fit$ind$coord[,1:2]
rownames(coord) <- datos$VARIEDAD
colnames(coord) <- c("c1","c2")
cluster_cuantitativas <- hclust(dist(coord), method = "average")
saveRDS(
  cluster_cuantitativas,
  here::here("doc", "tp1", "shared", "parte_3", "cluster_cuantitativas.rds")
)
```

```{r}
dendro_data <- dendro_data_k(cluster_cuantitativas, k=3)
```



```{r, fig.cap="Caracterizacion cuantitativa de las variedades de pepino."}
aux <- as_tibble(coord)
aux$label <- datos$VARIEDAD
aux <- aux %>% left_join(dendro_data$labels %>% select(clust,label))

ggplot(aux) + 
  geom_point(aes(c1, c2, color = factor(clust)), size = 4) + 
  geom_label_repel(aes(c1, c2, label = label), max.overlaps = 30) + 
  geom_vline(xintercept = 0, linetype = "dashed") + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  labs(
    x = "Coordenada 1",
    y = "Coordenada 2",
    color = "Grupos"
  )
```


```{r, fig.height=6.5, fig.width=6, fig.cap="Dendograma Ultrametrico con ligamiento UPGMA."}
ggplot(dendro_data$segments) + 
  geom_segment(
    aes(x = x, y = y, xend = xend, yend = yend, color = as.factor(clust)),
    size = 1.2,
    lineend = "round"
  ) + 
  geom_text(
    aes(x = x, y = y -  0.125, label = label, color = as.factor(clust)), 
    data = dendro_data$labels
  ) + 
  coord_flip() + 
  labs(
    y = "Distancia"
  ) + 
  scale_colour_manual(
    values = c("grey30", scales::hue_pal()(4))
  ) + 
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    panel.background = element_blank(),
    axis.title.x = element_text(size = 14), 
    axis.title.y = element_blank(), 
    axis.text.x = element_text(size = 12),
    axis.text.y = element_blank(), 
    axis.line = element_blank(), 
    axis.ticks.y = element_blank(),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"
  )
```


**C.** Evalúe visualmente y a través de la correlación entre matrices la concordancia general entre esta configuración y la hallada en función de los caracteres cualitativos

- Visualmente, se observa que la clusterización en base a componentes principales no logra separar las variadades P y F

- Si analizamos los grupos resultantes para la clusterización en base a las variables cualitativas vs. las cuantitativas en una tabla de contingencia, se observa que 

```{r}
cluster_cualitativas <- readRDS(
  here::here("doc", "tp1", "shared", "parte_2", "cluster_cualitativas.rds")
) 
dendro_data_cuali <- dendro_data_k(cluster_cualitativas, k=4)


aux <- aux %>% 
  left_join(
    dendro_data_cuali$labels %>% 
      select(clust,label) %>% 
      rename("clust_cuali"=clust)
    ) %>% 
  rename("clust_cuanti"=clust)


saveRDS(
  aux,
  here::here("doc", "tp1", "shared", "parte_3", "Coordenadas_1y2_pp_Clusters.rds")
)

```

```{r}
tabla <- table(
  aux %>% select(clust_cuanti, clust_cuali )
  )
tabla <- as_tibble(
  rbind(tabla[1,1:4],tabla[2,1:4],tabla[3,1:4])
)
tabla$Cluster_Cuanti <- 1:3
tabla <- tabla %>% select(Cluster_Cuanti, `1`,`2`,`3`, `4`)

tabla %>% 
  kable() %>% 
  kable_styling(font_size = 8, full_width = FALSE, latex_options = "HOLD_position") %>% 
  add_header_above(
    c(" " = 1, "Cluster_Cuali" = 4)
    ) %>% 
  kable_classic_2()
  
```

```{r}
#cor()
```


