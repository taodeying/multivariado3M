---
title: "Trabajo practico 1"
subtitle: "Ejercicio 3"
author: "Grupo ....."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    extra_dependencies: ["float"]
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center",
  fig.pos = "H", out.extra = "", fig.height = 4, fig.width = 6
)
```


## Librerias

```{r}
library(ggrepel)
library(kableExtra)
library(FactoMineR)
library(tidyverse)
source(here::here("src", "utils.R"))
```


## Datos

En el archivo CUANTITATIVAS se presentan los datos correspondientes a la caracterización agronómica cuantitativa de las 41 variedades de pepino tratadas en el ejercicio anterior. Los caracteres cuantitativos analizados fueron: número de flores femeninas por nudo (FLORES), número de espinas en el ovario (ESPINAS), número de aristas (ARISTAS) y estrías (ESTRIAS) en fruto, longitud de fruto (FRUTO), intensidad de cuello (CUELLO) e intensidad de color de cuello (CCUELLO)

```{r}
datos <- read_csv2(here::here("data", "raw", "CUANTITATIVAS.csv")) %>% 
  rename("VARIEDAD"=X1)
```


**A.** Aplique sobre estos datos un Análisis de Componentes Principales a partir de matriz de correlaciones.

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut congue in est vel commodo. Aliquam congue sapien at nibh feugiat hendrerit. Donec sit amet diam ipsum. Donec porta augue eu ex pulvinar, at viverra sem finibus. Sed ac elit nec purus vestibulum egestas. Nulla maximus imperdiet neque nec vehicula. Nulla eget aliquam libero, non iaculis nulla. Nunc aliquet tempus libero a viverra. Maecenas auctor feugiat turpis maximus gravida. Quisque cursus lectus nec nisi varius, a faucibus augue laoreet. 

```{r}
fit <- FactoMineR::PCA(
    datos[,-1],          # Remover variables cualitativas
    scale.unit=TRUE,     # Escalar las variables == pca con corr mat
    graph = FALSE
    )

saveRDS(
  fit,
  here::here("doc", "tp1", "shared", "parte_3", "pca.rds")
)
```

```{r}
(round(fit$eig,2)) %>% 
    kable() %>% 
    kable_styling(font_size = 8, full_width = FALSE, latex_options = "HOLD_position") %>% 
    kable_classic_2() 
```

```{r}
aux <- as.data.frame(fit$eig)
aux$comp <- rownames(aux)


ggplot(data = aux) +
    geom_bar(aes(x = comp,
                 weight = `percentage of variance`)) +
    geom_line(aes(x = 1:7,
                  y = `percentage of variance`),
              col = "blue",
              lwd = 1.2) +
    geom_line(aes(x = 1:7,
                  y = `cumulative percentage of variance`),
              col = "red",
              lwd = 1.2) +
    theme_minimal()
```



Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut congue in est vel commodo. Aliquam congue sapien at nibh feugiat hendrerit. Donec sit amet diam ipsum. Donec porta augue eu ex pulvinar, at viverra sem finibus. Sed ac elit nec purus vestibulum egestas. Nulla maximus imperdiet neque nec vehicula. Nulla eget aliquam libero, non iaculis nulla. Nunc aliquet tempus libero a viverra. Maecenas auctor feugiat turpis maximus gravida. Quisque cursus lectus nec nisi varius, a faucibus augue laoreet. 

**B.** Realice la representación de las variedades en el plano principal, encuentre grupos y caracterícelos


Variables Cuello, Estrias, Frutos y Flores permiten separar las Variedades H del resto. En segunda medida, las variables Espinas, Aristas y Ccuello, separan las P y F de las A

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut congue in est vel commodo. Aliquam congue sapien at nibh feugiat hendrerit. Donec sit amet diam ipsum. Donec porta augue eu ex pulvinar, at viverra sem finibus. Sed ac elit nec purus vestibulum egestas. Nulla maximus imperdiet neque nec vehicula. Nulla eget aliquam libero, non iaculis nulla. Nunc aliquet tempus libero a viverra. Maecenas auctor feugiat turpis maximus gravida. Quisque cursus lectus nec nisi varius, a faucibus augue laoreet. 

```{r}
coord <- fit$ind$coord[,1:2]
rownames(coord) <- datos$VARIEDAD
colnames(coord) <- c("c1","c2")
cluster_cuantitativas <- hclust(dist(coord), method = "average")
# saveRDS(
#   cluster_cuantitativas,
#   here::here("doc", "tp1", "shared", "parte_3", "cluster_cuantitativas.rds")
# )

```

```{r}
dendro_data <- dendro_data_k(cluster_cuantitativas, k=3)
```



```{r, fig.cap="Caracterizacion cuantitativa de las variedades de pepino."}
aux <- as_tibble(coord)
aux$label <- datos$VARIEDAD
aux <- aux %>% left_join(dendro_data$labels %>% select(clust,label))

ggplot(aux) + 
  geom_point(aes(c1, c2, color = factor(clust)), size = 4) + 
  geom_label_repel(aes(c1, c2, label = label), max.overlaps = 30) + 
  geom_vline(xintercept = 0, linetype = "dashed") + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  labs(
    x = "Coordenada 1",
    y = "Coordenada 2",
    color = "Grupos"
  )
```

```{r}
cluster_cualitativas <- readRDS(
  here::here("doc", "tp1", "shared", "parte_2", "cluster_cualitativas.rds")
) 
dendro_data_cuali <- dendro_data_k(cluster_cualitativas, k=4)


aux <- aux %>% 
  left_join(
    dendro_data_cuali$labels %>% 
      select(clust,label) %>% 
      rename("clust_cuali"=clust)
    ) %>% 
  rename("clust_cuanti"=clust)


saveRDS(
  aux,
  here::here("doc", "tp1", "shared", "parte_3", "Coordenadas_1y2_pp_Clusters.rds")
)

```


```{r, fig.cap="Gradiente de las Variables"}
plot(fit,choix = "var")

```


**C.** Evalúe visualmente y a través de la correlación entre matrices la concordancia general entre esta configuración y la hallada en función de los caracteres cualitativos

- Visualmente, se observa que la clusterización en base a componentes principales no logra separar las variadades P y F


```{r}
matriz_distancia_cuali <- readRDS(
      here::here("doc", "tp1", "shared", "parte_2", "matriz_distancia.rds")
    )  
cuali.cp <- cmdscale(sqrt(matriz_distancia_cuali), k = 2, eig = TRUE)

```



Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut congue in est vel commodo. Aliquam congue sapien at nibh feugiat hendrerit. Donec sit amet diam ipsum. Donec porta augue eu ex pulvinar, at viverra sem finibus. Sed ac elit nec purus vestibulum egestas. Nulla maximus imperdiet neque nec vehicula. Nulla eget aliquam libero, non iaculis nulla. Nunc aliquet tempus libero a viverra. Maecenas auctor feugiat turpis maximus gravida. Quisque cursus lectus nec nisi varius, a faucibus augue laoreet. 

```{r}

cor(
  as.vector(dist(cuali.cp$points)),
  as.vector(dist(coord))
    )


```


