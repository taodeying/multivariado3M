---
title: "Trabajo practico 1"
subtitle: "Parte 7"
author: "Grupo ....."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    extra_dependencies: ["float"]
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center",
  fig.pos = "H", out.extra = "", fig.height = 3, fig.width = 4.5
)
colores <- c("#003f5c", "#7a5195", "#ef5675", "#ffa600")
```

```{r}
library(cluster)
library(FactoMineR)
library(ggforce)
library(ggrepel)
library(kableExtra)
library(patchwork)
library(tidyverse)
```

```{r}
datos_m1 <- read_csv2(here::here("data", "raw", "MAIZ1.csv"))
datos_m2 <- read_csv2(here::here("data", "raw", "MAIZ2.csv"))
```

```{r}
class(datos_m1) <- "data.frame"
class(datos_m2) <- "data.frame"

rownames(datos_m1) <- datos_m1$Poblacion
rownames(datos_m2) <- datos_m2$Poblacion

datos_m1 <- datos_m1[-1]
datos_m2 <- datos_m2[-1]
```

A) Cuantifique la concordancia de la configuración de poblaciones nativas 
de maíz en ambos ambientes en el espacio original mediante el coeficiente de 
correlación de Pearson entre matrices de distancias euclídeas estandarizadas 
entre individuos, y utilizando el coeficiente Rv.

    Lo primero que hacemos es calcular las matrices de distancia entre las 
    poblaciones de maiz a partir de las variables estandarizadas, uilizando la 
    distancia euclidea.

    ```{r, echo=TRUE}
    dist_m1 <- dist(scale(datos_m1), method = "euclidean")
    dist_m2 <- dist(scale(datos_m2), method = "euclidean")
    correlacion <- cor(dist_m1, dist_m2)
    ```
    
    La correlacion entre las matrices de distancia es igual a 
    `r round(correlacion, 3)`. Esto indica que existe una concordancia 
    media-alta entre la configuracion de las poblaciones de maiz en ambos 
    ambientes.
    
    Por otro lado, tambien calculamos el coeficiente `RV`.
    
    ```{r, echo=TRUE}
    coef_rv <- coeffRV(scale(datos_m1), scale(datos_m2))
    ```
    
    Este resulta `r round(coef_rv$rv, 3)`, que es menor a la correlacion entre
    las matrices de distancia calculada anteriormente. **por que?**
    
    ```{r, fig.cap="Distancia entre poblaciones para los ambientes Pergamino y Ferre. La linea azul representa a la recta identidad."}
    concordancia_df <- data.frame(
      x = as.vector(dist_m1),
      y = as.vector(dist_m2)
    )
    ggplot(concordancia_df) + 
      geom_abline(slope = 1, size = 1.2, alpha = 0.8, color = colores[1]) +
      geom_point(aes(x, y), size = 3, alpha = 0.7, color = "grey30") + 
      labs(
          x = "Pergamino",
          y = "Ferre"
      )
    ```
    
A) Realice un ACP para cada ambiente, compare semejanzas y diferencias entre
ambas caracterizaciones tanto para individuos como para variables.

    Utilizamos la sentencia `PCA()` de la libreria `FactoMineR`.

    ```{r, echo=TRUE}
    acp_m1 <- PCA(datos_m1, ncp = 2, graph = FALSE)
    acp_m2 <- PCA(datos_m2, ncp = 2, graph = FALSE)
    ```
    
    Y luego obtenemos los graficos para los individuos y para las variables 
    en el plano principal.
    
    ```{r}
    # Preparo los datos
    individuos_pca1 <- as.data.frame(acp_m1$ind$coord)
    individuos_pca1$etiqueta <- rownames(individuos_pca1)
    
    variables_pca1 <- as.data.frame(acp_m1$var$coord)
    variables_pca1$etiqueta <- rownames(variables_pca1)
    variables_pca1$x0 <- 0
    variables_pca1$y0 <- 0
    
    individuos_pca2 <- as.data.frame(acp_m2$ind$coord)
    individuos_pca2$etiqueta <- rownames(individuos_pca2)
    
    variables_pca2 <- as.data.frame(acp_m2$var$coord)
    variables_pca2$etiqueta <- rownames(variables_pca2)
    variables_pca2$x0 <- 0
    variables_pca2$y0 <- 0
    
    ```
    
    ```{r}
    biplot <- function(individuos, variables) {
      r <- ggplot(individuos) + 
        geom_point(aes(Dim.1, Dim.2), size = 2.5, color = "gray30") + 
        geom_label_repel(aes(Dim.1, Dim.2, label = etiqueta), max.overlaps = 30) + 
        geom_vline(xintercept = 0, linetype = "dashed", color = "gray30", alpha = 0.5) + 
        geom_hline(yintercept = 0, linetype = "dashed", color = "gray30", alpha = 0.5) +
        labs(
          x = "Dimension 1", y = "Dimension 2"
        )
      l <- ggplot(variables) + 
        geom_segment(
          aes(x = x0, y = y0, xend = Dim.1, yend = Dim.2),
          arrow = arrow(length = unit(0.15, "cm"), type ="closed"),
          size = 1.15,
          color =  "gray30"
        ) + 
        geom_label_repel(
          aes(Dim.1, Dim.2, label = etiqueta), 
          min.segment.length = 0,
          max.overlaps = 30
        ) + 
        geom_vline(xintercept = 0, linetype = "dashed", color = "gray30", alpha = 0.5) + 
        geom_hline(yintercept = 0, linetype = "dashed", color = "gray30", alpha = 0.5) +
        geom_circle(
          aes(x0 = x, y0 = y, r = r), 
          linetype = "dashed", color = "gray30", alpha = 0.5,
          data = data.frame(x = 0, y = 0, r = 1)
        ) + 
        lims(x = c(-1, 1), y = c(-1, 1)) + 
        labs(x = "Dimension 1", y = "Dimension 2")
      l + r
    }
    ```
    
    ```{r, fig.width = 11, fig.height = 5, fig.cap="Caracterizacion de los individuos y las variables en el plano principal del ACP para el ambiente Pergamino."}
    biplot(individuos_pca1, variables_pca1)
    ```
    
    ```{r, fig.width = 11, fig.height = 5, fig.cap="Caracterizacion de los individuos y las variables en el plano principal del ACP para el ambiente Ferre."}
    biplot(individuos_pca2, variables_pca2)
    ```

    Respecto al grafico de las variables, vemos que en ambos ambientes se da que 
    **rendimiento** y **peso cada 1000 granos** son las que mas contribuyen a 
    la primera dimension. En cambio, las variables que mas contribuyen al segundo 
    eje dependen del ambiente. En el ambiente Pergamino se trata e las variables 
    asociadas al grano, **largo** y **ancho**, mientras que en el ambiente Ferre
    se trata de la **altura de la planta** y la **altura de la mazorca**.
    
    El angulo entre los vectores asociados a las cargas nos brinda informacion
    sobre la relacion entre las variables, y podemos ver si estas relaciones
    varian segun el ambiete. Por ejemplo, en Pergamino se da que la altura de 
    la planta y de la mazorca se relacionan positivamente con el rinde, 
    indicando que plantas con mayor altura y mazorcas mas largas se asocian a rindes mayores. 
    Sin embargo, esta asociacion no sucede en el ambiente Ferre, donde vemos 
    por el angulo entre los vectores, que el rendimiento de la planta no se 
    asocia a estas variables de altura.

    En cuanto al grafico de los individuos, lo primero que se observa es que la 
    poblacion **44** presenta en ambos ambientes un comportamiento muy diferente 
    al resto. Podemos ver que tiene valores muy bajos en la primer componente, 
    lo que indica que se trata de una poblacion con un rendimiento y un peso de
    grano muy inferior al resto de las poblaciones.
    
    **todo:** ver que onda el % de varianza explicada por las primeras dos
    componentes en ambos casos.

A) Cuantifique la relación de las dos configuraciones en el plano principal 
originado por los ACP
    
    **todo:** como uso plano principal, aca si tengo que quedarme con las
    primeras dos coordenadas.

A) Encuentra indicios de interacción tanto genotipo-ambiente como 
variable-ambiente ?

A) Como se quiere encontrar una caracterización ‘media’ o ‘promedio’ para las 
31 poblaciones en función de la información dada en ambos ambientes proceda a 
realizar una ACP sobre el promedio de las variables para ambos ambientes

A) Ahora concatene ambos archivos por filas y columnas y realice un ACP para 
ambas situaciones, encuentra respuesta para las interacciones planteadas en el 
inciso b ?

A) Aplicar APG para tener otra visualización de la interacción genotipo-ambiente
(retenga todas las dimensiones de ambas configuraciones).



    ```{r}
    acp_m1 <- PCA(datos_m1, ncp = 10, graph = FALSE)
    acp_m2 <- PCA(datos_m2, ncp = 10, graph = FALSE)
    
    df = data.frame(cbind(acp_m1$ind$coord, acp_m2$ind$coord))
    ```
    
    
    ```{r}
    gpa <- GPA(df, group = c(10, 10), name.group = c("Per", "Fer"), graph = FALSE)
    ```

A) Visualizar del gráfico correspondiente las 3 poblaciones con mayor efecto 
ambiente y las 3 con menor efecto


    ```{r}
    parcial_1 <- as.data.frame(gpa$Xfin[, , 1][, 1:2])
    parcial_2 <- as.data.frame(gpa$Xfin[, , 2][, 1:2])
    colores_fct <-as.factor(c(rep(1:4, 7), 1:3))
    
    parcial_1$ambiente <- "Pergamino"
    parcial_1$color <- colores_fct
    parcial_2$ambiente <- "Ferre"
    parcial_2$color <- colores_fct
    parciales <- rbind(parcial_1, parcial_2)
    parciales$etiquetas <- rownames(parciales)
    
    segmentos <- cbind(parcial_1[, 1:2], parcial_2[, 1:2])
    names(segmentos) <- c("x0", "y0", "x1", "y1")
    segmentos$color <- colores_fct
    
    centros <- (parcial_1[, 1:2] + parcial_2[, 1:2]) / 2
    names(centros) <- c("x", "y")
    centros$etiqueta <- rownames(centros)
    centros$color <-colores_fct
    ```
    
    
    ```{r, fig.width = 7, fig.height = 5}
    ggplot(parciales) + 
      geom_vline(xintercept = 0, linetype = "dashed", color = "gray30", alpha = 0.5) + 
      geom_hline(yintercept = 0, linetype = "dashed", color = "gray30", alpha = 0.5) +
      geom_segment(
        aes(x0, y0, xend=x1, yend=y1, color=color),
        show.legend = FALSE,
        data = segmentos
      ) + 
      geom_point(
        aes(dim.1, dim.2, shape = ambiente, color = color),
        size = 1.5,
      ) + 
      geom_point(
        aes(x, y, color = color),
        size = 0.75,
        data = centros
      ) + 
      geom_label_repel(
        aes(x, y, label = etiqueta), 
        min.segment.length = 0,
        max.overlaps = 30,
        size = 3,
        data = centros
      ) + 
      scale_color_manual(values = colores, guide=FALSE) + 
      scale_shape_discrete(name = "Ambiente") + 
      theme(legend.position = "top")
    ```

```{r}
# points(gpa$consensus[, 1:2])
# points(gpa$Xfin[, , 1][, 1:2])
# points(gpa$Xfin[, , 2][, 1:2])
```


A) Comparar lo encontrado en h) con el ANOVA correspondiente. Realice comentarios

No van a coincidir porque el dibujo esta en 2d y el ANOVA usa a las 10 dimensiones para calcular la suma de cuadrados residual.