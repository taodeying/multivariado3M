---
title: "Ejercicio 3"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center",
  fig.pos = "H", out.extra = "", fig.height = 3.5, fig.width = 5
)
colores <- c("#003f5c", "#7a5195", "#ef5675", "#ffa600")
```

```{r}
library(FactoMineR)
library(ggplot2)
library(ggforce)
library(ggrepel)
library(kableExtra)
# library(patchwork)
library(tidyverse)
# library(vegan)
source(here::here("src", "utils.R"))
```


Los datos del archivo banana16 corresponden a 40 poblaciones de banana (Musa spp.) de las cuales 20 son
clones de origen genético desconocido (recolectados en campos de productores) y 20 son variedades de uso internacional Jaffa, Gal, Gran Enanao y Williams, respectivamente (testigos). 

Los datos son un extracto de la base original perteneciente al Centro Regional Chaco – Formosa de INTA.

Las variables consideradas son:
 
 *    AltPlan: altura de planta (m)
 *    DiamPlan: diámetro de planta (cm)
 *    HojasFlor: cantidad de hojas a floración
 *    NManos: cantidad de manos
 *    Rend: rendimiento (kg)


```{r}
data <- read.csv2(
  here::here("data", "raw", "banana16.csv"), 
  row.names = 1, 
  stringsAsFactors = FALSE
)

clones <- filter(data, tipo == "clon")
test <- filter(data, tipo == "test")

```

**a)** Analice las correlaciones entre variables en ambos grupos.

Matriz de correlacion
```{r}

corrplot::corrplot(cor(data[,-6]))

```

Matriz de correlacion grupo _Clones_
```{r}

corrplot::corrplot(cor(clones[,-6]))

```

Matriz de correlacion grupo _Testigos_
```{r}

corrplot::corrplot(cor(test[,-6]))

```

    Al obtener las matrices de correlaciones entre las variables podemos ver que las mismas son todas positivas, tanto en el grupo "Clones" como en el grupo "Testigos". Cabe destacar que es notable la diferencia en las magnitudes de las correlaciones en los grupos. 
    
    Si observamos la matriz correspondiente al grupo "Clones" podemos ver que la variable Rendimiento presenta una correlacion alta con Diametro de Planta y, en menor medida con Hojas a Floracion. Ademas se observan correlaciones, de moderadas a altas, para las variables Diamtro de Planta con Cantidad de Manos y Hojas a Floracion.
    
    Por otro lado, observando la matriz del grupo "Testigo" vemos que la variable Rendimiento, a diferencia de lo observado en la matriz anterior, esta mas correlacionada con Altura de planta. 
    
    Otra diferencia a destacar, es que la variable Diamtro de planta presenta correlaciones mas altas en el grupo "Clones" que en el grupo "Testigos".


Realice un Análisis Factorial Múltiple Dual y responda las siguientes cuestiones:

**b)** ¿Cuál es el porcentaje de explicación del plano principal?

```{r}

afmd <- DMFA(data, num.fact = 6, graph = FALSE, ncp = 2)

```

```{r, fig.width = 7, fig.height=4}

autovalores_vector <- as.vector(prop.table(afmd$eig[, 1]))
    autovalores <- data.frame(
      x = 1:5,
      varianza = autovalores_vector,
      varianza_cum = cumsum(autovalores_vector)
    )
    autovalores$label <- paste0(round(autovalores$varianza * 100), "%")
    
    ggplot(autovalores, aes(x = x)) + 
      geom_hline(yintercept = 1, linetype = "dashed", color = "gray30", alpha = 0.5) + 
      geom_col(aes(y = varianza), fill = colores[1]) +
      geom_line(
        aes(y = varianza_cum), 
        linetype = "dashed",
        size = 1.2, 
        color = "grey30",
        lineend = "round"
      ) + 
      geom_label(
        aes(y = varianza, label = label), 
        nudge_y = 0.025
      ) + 
      scale_x_continuous(
        breaks = 1:13
      ) + 
      scale_y_continuous(
        labels = scales::percent_format()
      ) + 
      labs(
        x = "Componente",
        y = "Varianza"
      ) + 
      theme(
        panel.grid.minor.x = element_blank()
      )
    
    
```

    El porcentaje de variabilidad explicada sobre el plano princial es del `r round(afmd$eig[2,3],2)`%. Como puede observarse en la figura anterior, el primer autovalor explica un `r round(afmd$eig[1,2],2)`% mientras que el segundo un `r round(afmd$eig[2,2],2)`%


**c)** ¿Qué puede decir a partir del gráfico de las condiciones?


```{r, fig.cap="Caracterizacion de los grupos en el plano principal AFM."}
    
    d = as.data.frame(afmd$group$coord.n)[, 1:2]
    d$Grupo = rownames(d)
    rownames(d) = NULL
    colnames(d) = c("x", "y", "Grupo")

   ggplot(d) +
      geom_point(aes(x, y, color = Grupo), size = 3) + 
      geom_label(aes(x, y, label = Grupo), nudge_x = -0.075, nudge_y = -0.075) + 
      geom_hline(yintercept = 0, linetype = "dashed", color = "gray30", alpha = 0.5) +
      geom_vline(xintercept = 0, linetype = "dashed", color = "gray30", alpha = 0.5) +
      scale_color_manual(values = colores[c(1, 3)], guide = FALSE) + 
      labs(
        x = "Coordenada 1 (51.35%)",
        y = "Coordenada 2 (18.37%)",
        title = "Representacion de las Variables"
      ) +
      lims(x = c(0, 1), y = c(0, 1))
    
    ```

    Al representar los grupos sobre el plano principal podemos observar que ambos tienen una alta relacion con la primera dimension, aportando en igual medida a la misma; pero si se proyectan los puntos sobre la segunda dimension, puede observarse que el grupo "Testigo" tiene un aporte levemente mayor en la formacion de esta. 
    

**d)** ¿Cómo se ven representadas en los gráficos del DMFA las conclusiones del inciso a)?


    Para poder observar los principales cambios que intridujo el agrupamiento de individuos se comparan los graficos de las variables consesos con los graficos de las variables parciales.

Variables consesos: 
```{r}
ade4::s.corcircle(afmd$var$coord)
```


```{r}

plot(afmd, 
     choix = "var", label = "all",
     xlim = NULL, 
     ylim = NULL,
     title = NULL,
     cex = 0.7,
     cex.main = 0.8,
     cex.lab = 1)

```

##ver como poner los graficos anteriores de las elipses!!!!!
    
    Al considerar el grupo "Clones", vemos que Altura de planta y Cantidad de manos se mantienen igual, pero luego del agrupamiento de individuos observamos que Rendimiento tiene una coordenada negativa sobre el eje 2 (es por esto ultimo, ademas, que observamos las elipses con una leve inclinacion hacia la izquiera).
        
    En el grupo "Testigos" podemos observar que, luego del agrupamiento de individuos, la variable Rendimiento tiene una coordenada mayor en el eje 2; esto se debe a que, como vimos en la matriz de correlacion correspondiente a este grupo, presenta una correlacion positiva alta con altura de planta (en este caso, podemos observar que la elipse presenta una leve inclinacion a la derecha). 





 